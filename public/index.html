<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complete the Word - Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">Complete the Word — Multiplayer</h1>

    <div id="setup" class="space-y-4">
      <div class="flex gap-2 items-center">
        <label class="w-44">Number of players:</label>
        <input id="numPlayers" type="number" min="2" value="2" class="border rounded px-2 py-1" />
        <button id="setPlayers" class="ml-2 px-3 py-1 bg-blue-600 text-white rounded">Set</button>
      </div>
      <div id="namesContainer" class="space-y-2"></div>
      <div>
        <button id="startGame" class="px-4 py-2 bg-green-600 text-white rounded">Start Game</button>
      </div>
    </div>

    <div id="gameArea" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <div id="playersWrap" class="flex-1"></div>
        <div class="text-right">
          <button id="restartBtn" class="px-3 py-1 bg-red-500 text-white rounded">Restart</button>
        </div>
      </div>

      <div class="flex items-center justify-center">
        <div class="w-96 h-64 bg-slate-100 rounded-lg flex flex-col items-center justify-center">
          <div class="text-lg text-slate-700">Word so far</div>
          <div id="currentWord" class="text-4xl font-mono my-2"> </div>
          <div id="statusLine" class="text-sm">Status: <span id="statusText">—</span></div>

          <div id="letterInputWrap" class="mt-4">
            <input id="letterInput" maxlength="1" class="border px-2 py-1 text-center w-20 text-2xl rounded" />
            <button id="submitLetter" class="ml-2 px-3 py-1 bg-blue-600 text-white rounded">Enter</button>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h3 class="font-semibold">Eliminated / Used Words</h3>
        <div class="flex gap-4 mt-2">
          <div>
            <div class="text-sm text-slate-600">Eliminated:</div>
            <ul id="elimList" class="list-disc pl-5"></ul>
          </div>
          <div>
            <div class="text-sm text-slate-600">Used Words:</div>
            <ul id="usedList" class="list-disc pl-5"></ul>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
const apiCheck = async (current) => {
  const res = await fetch('/api/check', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ current })
  });
  return res.json();
}

let players = [];
let active = [];
let currentIndex = 0;
let currentWord = '';
let usedWords = new Set();
let timerInterval = null;
let timeLeft = 10;

const numPlayersInput = document.getElementById('numPlayers');
const setPlayersBtn = document.getElementById('setPlayers');
const namesContainer = document.getElementById('namesContainer');
const startBtn = document.getElementById('startGame');

setPlayersBtn.addEventListener('click', () => {
  const n = parseInt(numPlayersInput.value) || 2;
  namesContainer.innerHTML = '';
  for (let i=0;i<n;i++) {
    const div = document.createElement('div');
    div.className = 'flex gap-2 items-center';
    div.innerHTML = `<label class="w-44">Player ${i+1} name:</label><input class="playerName border rounded px-2 py-1" value="Player ${i+1}" />`;
    namesContainer.appendChild(div);
  }
});

startBtn.addEventListener('click', () => {
  const nameInputs = Array.from(document.querySelectorAll('.playerName'));
  if (nameInputs.length < 2) { alert('Need at least 2 players'); return; }
  players = nameInputs.map(i => i.value.trim()||'Player');
  active = players.map((p, idx) => ({ name: p, eliminated: false, index: idx }));
  document.getElementById('setup').classList.add('hidden');
  document.getElementById('gameArea').classList.remove('hidden');
  renderPlayers();
  currentIndex = 0;
  currentWord = '';
  usedWords = new Set();
  updateUI();
  startTurn();
});

document.getElementById('restartBtn').addEventListener('click', () => {
  location.reload();
});

function renderPlayers() {
  const wrap = document.getElementById('playersWrap');
  wrap.innerHTML = '';
  active.forEach((p, idx) => {
    const div = document.createElement('div');
    div.className = 'inline-block mr-4 text-center';
    div.id = 'player-'+idx;
    div.innerHTML = `<div class="font-semibold" id="pname-${idx}">${p.name}</div><div id="ptimer-${idx}" class="text-sm text-slate-500">10s</div>`;
    wrap.appendChild(div);
  });
}

function updateUI() {
  document.getElementById('currentWord').textContent = currentWord || '—';
  document.getElementById('statusText').textContent = '—';
  document.getElementById('elimList').innerHTML = active.filter(p=>p.eliminated).map(p=>`<li>${p.name}</li>`).join('') || '<li>—</li>';
  document.getElementById('usedList').innerHTML = Array.from(usedWords).map(w=>`<li>${w}</li>`).join('') || '<li>—</li>';
  // highlight current
  active.forEach((p, idx) => {
    const el = document.getElementById('player-'+idx);
    if (!el) return;
    if (idx === currentIndex && !p.eliminated) {
      el.classList.add('bg-yellow-100','p-2','rounded');
    } else {
      el.classList.remove('bg-yellow-100','p-2','rounded');
    }
    const timerEl = document.getElementById('ptimer-'+idx);
    if (timerEl) timerEl.textContent = p.eliminated ? 'X' : (idx === currentIndex ? timeLeft + 's' : '10s');
  });
}

async function submitLetter() {
  const input = document.getElementById('letterInput');
  const v = (input.value || '').trim().toLowerCase();
  if (!v.match(/^[a-z]$/)) { alert('Enter a single alphabet'); return; }
  input.value = '';
  // append and check
  currentWord += v;
  const resp = await apiCheck(currentWord);
  const statusText = document.getElementById('statusText');
  if (!resp.canContinue) {
    statusText.textContent = '❌ INVALID — eliminated';
    eliminateCurrent();
    return;
  } else {
    statusText.textContent = '✅ VALID';
  }
  // Check if it's a full word but don't end the game
  if (resp.isWord) {
    // completed a full word
    if (usedWords.has(currentWord)) {
      statusText.textContent = '❌ Word already used — eliminated';
      eliminateCurrent();
      return;
    }
    usedWords.add(currentWord);
    statusText.textContent = `✅ VALID WORD: ${currentWord.toUpperCase()}`;
    // Continue the game - don't reset or change turns
  }
  // Continue to next player only if it's not a full word
  if (!resp.isWord) {
    nextTurn();
  }
}

function eliminateCurrent() {
  clearInterval(timerInterval);
  active[currentIndex].eliminated = true;
  updateUI();
  const remaining = active.filter(p=>!p.eliminated);
  if (remaining.length === 1) {
    alert(`${remaining[0].name} wins!`);
    // Disable further input
    document.getElementById('letterInput').disabled = true;
    document.getElementById('submitLetter').disabled = true;
    return;
  }
  // find next
  let found = false;
  for (let i=1;i<=active.length;i++) {
    const idx = (currentIndex + i) % active.length;
    if (!active[idx].eliminated) { currentIndex = idx; found = true; break; }
  }
  timeLeft = 10;
  updateUI();
  startTurn();
}

function nextTurn() {
  clearInterval(timerInterval);
  // move to next active player
  for (let i=1;i<=active.length;i++) {
    const idx = (currentIndex + i) % active.length;
    if (!active[idx].eliminated) { currentIndex = idx; break; }
  }
  timeLeft = 10;
  updateUI();
  startTurn();
}

function startTurn() {
  updateUI();
  const input = document.getElementById('letterInput');
  input.focus();
  // start timer
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    updateUI();
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      alert(`${active[currentIndex].name} ran out of time and is eliminated.`);
      eliminateCurrent();
    }
  }, 1000);
}

document.getElementById('submitLetter').addEventListener('click', submitLetter);
document.getElementById('letterInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') submitLetter();
});

// initialize sample setup
setPlayersBtn.click();
</script>
</body>
</html>
